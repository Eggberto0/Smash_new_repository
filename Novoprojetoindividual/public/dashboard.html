<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="dashboard.css">
    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<body>
    <div class="tela">
        <div class="sidebar" id="sidebar"></div>
        <div class="navbar">
            <div class="navbar_logo">
                <div class="navbar_logo_image"></div>
            </div>
            <div class="navbar_logo_text"></div>
            <div class="navbar_opcoes">
                <a onclick="sidebarOpen()" style="cursor: pointer;">Menu</a>
            </div>
        </div>
    </div>
      <div class="container_index">
        <div class="texto-user">
          <div>
            <span>Bem-vindo</span>
            <span id="b_usuario"></span>
          </div>
            <h2>Personagens favoritos</h2>
        </div>
          <div class="grafico_body">
              <div id="content">
                  <div class="slide-show select-disable">
                      <canvas id="myChart"></canvas>
                  </div>
                </div>
            </div>
        </div>
    
</body>
</html>

<!-- <script>

const labels = ['January', 'February', 'March', 'April', 'May', 'June', 'July'];
    const data = {
      labels: labels,
      datasets: [{
        axis: 'y',
        label: 'My First Dataset',
        data: [65, 59, 80, 81, 56, 55, 40],
        fill: false,
        backgroundColor: [
          'rgba(255, 99, 132, 0.2)',
          'rgba(255, 159, 64, 0.2)',
          'rgba(255, 205, 86, 0.2)',
          'rgba(75, 192, 192, 0.2)',
          'rgba(54, 162, 235, 0.2)',
          'rgba(153, 102, 255, 0.2)',
          'rgba(201, 203, 207, 0.2)'
        ],
        borderColor: [
          'rgb(255, 99, 132)',
          'rgb(255, 159, 64)',
          'rgb(255, 205, 86)',
          'rgb(75, 192, 192)',
          'rgb(54, 162, 235)',
          'rgb(153, 102, 255)',
          'rgb(201, 203, 207)'
        ],
        borderWidth: 1
      }]
    };

    const config = {
      type: 'bar',
      data: data,
      options: {
        indexAxis: 'y'
      }
    };

    // Inicializar o gráfico
    const ctx = document.getElementById('myChart').getContext('2d');
    new Chart(ctx, config);

</script> -->

<!--sfaibdskfkjdsbjaskfjdkjbjksbfkjbdskjfsdkjfksdjbkjbfkjjdsbfkjjdsfjkbdskjfkdsbkjdbksbvjb jbvdbxscjbasdkjbdskjjfskdjjfdskjjfdskjjb-->

<script>
function sidebarOpen() {
        var Sbar = document.getElementById("sidebar");
        var width = Sbar.offsetWidth;

        if (width === 0) {
            Sbar.style.width = "250px";
            Sbar.innerHTML = `<div class="fecharSbar">
                <a onclick="sidebarOpen()" style="cursor: pointer;">x</a>
            </div>
            <div class="infosSbar">
                <a href="indexLogado.html" style="cursor: pointer;">Página Inicial</a>
                <a href="match.html" style="cursor: pointer;">Random Match</a>
                <a href="tela_inicio.html" style="cursor: pointer;">Sair</a>
            </div>`;
        } else {
            Sbar.style.width = "0";
            Sbar.innerHTML = "";
        }
    }
</script>

<script>


let proximaAtualizacao;

function obterDadosGrafico(idPersonagem) {

alterarTitulo(idPersonagem)

if (proximaAtualizacao != undefined) {
    clearTimeout(proximaAtualizacao);
}

fetch(`/medidas/ultimas/${idPersonagem}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse();

            plotarGrafico(resposta, idPersonagem);

        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });
}



function plotarGrafico(resposta, idPersonagem) {

console.log('iniciando plotagem do gráfico...');

// Criando estrutura para plotar gráfico - labels
let labels = [];

// Criando estrutura para plotar gráfico - dados
let dados = {
    labels: labels,
    datasets: [{
        label: 'Umidade',
        data: [],
        fill: false,
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
    },
    {
        label: 'Temperatura',
        data: [],
        fill: false,
        borderColor: 'rgb(199, 52, 52)',
        tension: 0.1
    }]
};

console.log('----------------------------------------------')
console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
console.log(resposta)

// Inserindo valores recebidos em estrutura para plotar o gráfico
for (i = 0; i < resposta.length; i++) {
    var registro = resposta[i];
    labels.push(registro.momento_grafico);
    dados.datasets[0].data.push(registro.umidade);
    dados.datasets[1].data.push(registro.temperatura);
}

console.log('----------------------------------------------')
console.log('O gráfico será plotado com os respectivos valores:')
console.log('Labels:')
console.log(labels)
console.log('Dados:')
console.log(dados.datasets)
console.log('----------------------------------------------')

// Criando estrutura para plotar gráfico - config
const config = {
    type: 'line',
    data: dados,
};

// Adicionando gráfico criado em div na tela
let myChart = new Chart(
    document.getElementById(`myChartCanvas${idPersonagem}`),
    config
);

setTimeout(() => atualizarGrafico(idPersonagem, dados, myChart), 2000);
}



function atualizarGrafico(idPersonagem, dados, myChart) {

fetch(`/medidas/tempo-real/${idPersonagem}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (novoRegistro) {

            obterdados(idPersonagem);
            // alertar(novoRegistro, idPersonagem);
            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico:`);
            console.log(dados);

            let avisoCaptura = document.getElementById(`avisoCaptura${idPersonagem}`)
            avisoCaptura.innerHTML = ""


            if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                console.log("---------------------------------------------------------------")
                console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                console.log("Horário do novo dado capturado:")
                console.log(novoRegistro[0].momento_grafico)
                console.log("Horário do último dado capturado:")
                console.log(dados.labels[dados.labels.length - 1])
                console.log("---------------------------------------------------------------")
            } else {
                // tirando e colocando valores no gráfico
                dados.labels.shift(); // apagar o primeiro
                dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

                dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                myChart.update();
            }

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idPersonagem, dados, myChart), 2000);
        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idPersonagem, dados, myChart), 2000);
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });

}

</script>